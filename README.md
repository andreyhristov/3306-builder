# 3306-builder

## What is 3306-builder?

3306-builder is a system for building MySQL (from source tarball or git clone) in a container. This means that you don't need to pollute your host system with libraries and compilers just to be able to compile MySQL from source.

## Which guest systems do 3306-builder support?

Currently 3306-builder supports the following containers:
* Ubuntu 16.04
* Ubuntu 14.04

Adding a new one is pretty easy. Dockerfile.1604 needs to be copied and the packets which are installed for 16.04 need to be installed on the equivalent new platform. For Debian only the FROM: part needs a change.

## How does 3306-builder work?

3306-builder uses Makefile magic. Make is most probably already available on your system. The commands are in the form of __make__ __command__
__command__ is one of:
* __compile__, which is executed even when make is calld without a command. Compile starts the C++ compiler in the container and let's it build MySQL
* __test__ runs all tests from the MySQL test suite by calling mysql-test-run
* __boost__ downloads and unpacks Boost, which is needed for building MySQL. Boost is not compiled as MySQL uses only headers and no libraries.
* __cmake__ configures MySQL for building by using a out-of-source build.
* __clean__ does a soft clean (make clean inside the out-of-souce build). This soft clean leaves the files generated by CMake but removes all object files.
* __ccache_clean__ cleans the cache of __ccache__. By default 3306-builder uses object file caching utilizing ccache. It does it only for C++ and not for C files (incompatibility). For every target (guest OS) there is a separate cache. This means that if you build in parallel for 14.04 and 16.04 the caches won't be mixed.
* __download__ downloads a tarball with MySQL source code and unpacks it for later compilation. You have to choose which tarball will be downloaded by supplying variables to the command. For example ```make download TAR_MAJOR_MINOR=5.7 TAR_PATCH=15``` will download MySQL 5.7.16 from http://dev.mysql.com . ```make download TAR_MAJOR_MINOR=8.0 TAR_PATCH=0-dmr``` will download MySQL 8.0.0-DMR. Be advised that versions that are not marked GA typically have a suffix for the patch version. __5.7.15_ has no suffix, but you see __8.0.0__ has __-dmr__ as suffix.
* __clone_git__ downloads the source from a Git repository. By default this will be https://github.com/mysql/mysql-server.git , however if you export an enviromental variable GIT_REMOTE_ORIGIN with value of other Git server it will be used. Here is an example ```export GIT_REMOTE_ORIGIN=http://example.com/mysql-server/server.git; make clone_git```
* __container__ builds a Docker container for compiling MySQL in it. In essence it uses Dockerfile.xxx to build one. __xxx__ is 1604 or 1404 (adding a new guest OS is quite easy, as already stated).
* __bootstrap_download__ is a short-cut for __download__-ing source from a tarball (see __download__), building the __container__, then __start__-ing it, downloading __boost__ in the container and as last configuring the build for out-of-source building with __cmake__.
* __bootstrap_git__ is a short-cut like __bootstrap_download__ but instead of downloading a tarball it does clone from a git repo. Automatically 3 branches are checked out - 5.6, 5.7 and 8.0 . 5.7 will be linked for building.
* __start__ starts the container
* __stop__ stops the container
* __shell__ executes interactive shell (__bash__) in the container

# How do I choose the guest OS?
There are 2 ways. Either you provide __OSVER__ with every command to run, like ```make start OSVER=1604``` or export an environment variable __ENVOS__ with some value and then call make without a variable. ```export ENVOS=14.04; make container```

# Sample session
```
andrey@host:/work/3306-builder$ make bootstrap_download TAR_MAJOR_MINOR=5.7 TAR_PATCH=15 BOOST_VERSION=59
cd src && \
        wget -c http://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.15.tar.gz && \
        rm server ; \
        tar zxvf mysql-5.7.15.tar.gz && \
        ln -s mysql-5.7.15 server && \
        rm mysql-5.7.15.tar.gz
--2016-09-14 18:19:29--  http://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.15.tar.gz
Resolving dev.mysql.com (dev.mysql.com)... 137.254.60.11
Connecting to dev.mysql.com (dev.mysql.com)|137.254.60.11|:80... connected.
HTTP request sent, awaiting response... 302 Found
Location: http://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.15.tar.gz [following]
--2016-09-14 18:19:29--  http://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.15.tar.gz
Resolving cdn.mysql.com (cdn.mysql.com)... 23.223.141.93
Connecting to cdn.mysql.com (cdn.mysql.com)|23.223.141.93|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 50539618 (48M) [application/x-tar-gz]
Saving to: mysql-5.7.15.tar.gz
....
mysql-5.7.15/storage/innobase/row/row0quiesce.cc
mysql-5.7.15/storage/innobase/row/row0row.cc
mysql-5.7.15/storage/innobase/row/row0sel.cc
mysql-5.7.15/storage/innobase/row/row0trunc.cc
mysql-5.7.15/storage/innobase/row/row0uins.cc
mysql-5.7.15/storage/innobase/row/row0umod.cc
mysql-5.7.15/storage/innobase/row/row0undo.cc
mysql-5.7.15/storage/innobase/row/row0upd.cc
mysql-5.7.15/storage/innobase/row/row0vers.cc
...
echo "Building Docker image"
Building Docker image
docker build -f Dockerfile.1604 . -t 3306-builder-1604
Sending build context to Docker daemon 1.351 GB
Step 1 : FROM ubuntu:16.04
 ---> bd3d4369aebc
Step 2 : MAINTAINER Andrey Hristov <andrey@php.net>
 ---> Running in 6d96fc1ffa33
 ---> 0fbb5354da2d
Removing intermediate container 6d96fc1ffa33
Step 3 : RUN apt-get update && apt-get install -y     wget     ccache     build-essential     libssl-dev     libncurses5-dev     bison     cmake     && apt-get clean &&     rm -rf /var/lib/apt/lists/*
 ---> Running in ad14fa002dab
...
47cac3196e6a1a06cc91cdff33736d5f1a96b86c9d114a66cb179130c726dc15
docker exec --user developer compiler1604 sh -c "cd /home/developer && cd /home/developer/boost && wget -c http://netix.dl.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.bz2 && tar jxvf boost_1_59_0.tar.bz2 && rm boost_1_59_0.tar.bz2"
--2016-09-14 15:26:19--  http://netix.dl.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.bz2
Resolving netix.dl.sourceforge.net (netix.dl.sourceforge.net)... 87.121.121.2
Connecting to netix.dl.sourceforge.net (netix.dl.sourceforge.net)|87.121.121.2|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 70389425 (67M) [application/octet-stream]
Saving to: 'boost_1_59_0.tar.bz2'

     0K .......... .......... .......... .......... ..........  0% 2.89M 23s
    50K .......... .......... .......... .......... ..........  0% 2.46M 25s
   100K .......... .......... .......... .......... ..........  0% 2.10M 27s
   150K .......... .......... .......... .......... ..........  0% 2.75M 27s
   200K .......... .......... .......... .......... ..........  0% 3.00M 26s
   250K .......... .......... .......... .......... ..........  0% 1.66M 28s
   300K .......... .......... .......... .......... ..........  0% 2.57M 28s
   350K .......... .......... .......... .......... ..........  0% 2.35M 28s
....
docker exec --user developer compiler1604 sh -c "cd /home/developer/build/ && find -name CMakeCache.txt -delete ; find -name CMakeFiles -exec rm -rf {} \; ; CC='' CXX='ccache g++' cmake /home/developer/src/server -DWITH_SSL:STRING=system -DMYSQL_MAINTAINER_MODE:BOOL=OFF -DWITH_DEBUG:BOOL=ON -DWITH_BOOST=/home/developer/boost/boost_1_59_0/"
find: './CMakeFiles': No such file or directory
-- Running cmake version 3.5.1
-- Could NOT find Git (missing:  GIT_EXECUTABLE) 
-- Configuring with MAX_INDEXES = 64U
-- The C compiler identification is GNU 5.4.0
-- The CXX compiler identification is GNU 5.4.0
-- Check for working C compiler: /usr/bin/cc
-- Check for working C compiler: /usr/bin/cc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
....
-- CMAKE_BUILD_TYPE: Debug
-- COMPILE_DEFINITIONS: _GNU_SOURCE;_FILE_OFFSET_BITS=64;HAVE_CONFIG_H;HAVE_LIBEVENT1
-- CMAKE_C_FLAGS:  -fPIC -Wall -Wextra -Wformat-security -Wvla -Wwrite-strings -Wdeclaration-after-statement
-- CMAKE_CXX_FLAGS:  -fPIC -Wall -Wextra -Wformat-security -Wvla -Woverloaded-virtual -Wno-unused-parameter
-- CMAKE_C_FLAGS_DEBUG: -g -fabi-version=2 -fno-omit-frame-pointer -fno-strict-aliasing -DENABLED_DEBUG_SYNC -DSAFE_MUTEX
-- CMAKE_CXX_FLAGS_DEBUG: -g -fabi-version=2 -fno-omit-frame-pointer -fno-strict-aliasing -DENABLED_DEBUG_SYNC -DSAFE_MUTEX
-- Configuring done
-- Generating done
-- Build files have been written to: /home/developer/build
andrey@host:/work/git-mysql/3306-builder$ make compile CPUS=6
docker exec --user developer compiler1604 sh -c "cd /home/developer/build/ && make -j6"
Scanning dependencies of target abi_check
Scanning dependencies of target INFO_BIN
Scanning dependencies of target INFO_SRC
[  0%] Generating common.h
Scanning dependencies of target zlib
[  0%] Building C object zlib/CMakeFiles/zlib.dir/adler32.c.o
[  0%] Generating help.c
[  0%] Built target INFO_SRC
[  1%] Generating help.h
...
```
